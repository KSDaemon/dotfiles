#!/bin/bash
# Ralph Wiggum - Long-running AI agent loop
# Based on original version from https://github.com/snarktank/ralph
# Usage: ./ralph.sh [--tool amp|claude|opencode] [-w|--worktree] [. ]
#   -w, --worktree: Use git worktree for isolated work (creates ../repo-name-feature-name/)

set -e

# Handle Ctrl+C gracefully - exit immediately without running cleanup commands
trap 'echo ""; echo "Ralph interrupted by user. Exiting..."; exit 130' INT TERM

# Parse arguments
TOOL="opencode"
MAX_ITERATIONS=100
USE_WORKTREE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --tool)
      TOOL="$2"
      shift 2
      ;;
    --tool=*)
      TOOL="${1#*=}"
      shift
      ;;
    -w|--worktree)
      USE_WORKTREE=true
      shift
      ;;
    *)
      # Assume it's max_iterations if it's a number
      if [[ "$1" =~ ^[0-9]+$ ]]; then
        MAX_ITERATIONS="$1"
      fi
      shift
      ;;
  esac
done

# Validate tool choice
if [[ "$TOOL" != "amp" && "$TOOL" != "claude" && "$TOOL" != "opencode" ]]; then
  echo "Error: Invalid tool '$TOOL'. Must be 'amp', 'claude', or 'opencode'."
  exit 1
fi

# Check tool is installed
if ! command -v "$TOOL" &> /dev/null; then
  echo "Error: $TOOL not found in PATH."
  exit 1
fi

WORK_DIR="$(pwd)"
RALPH_DIR="$WORK_DIR/.ralph"
mkdir -p "$RALPH_DIR"

# Get script directory for prompt file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROMPT_FILE="$SCRIPT_DIR/../ralph/prompt.md"

PRD_FILE="$RALPH_DIR/prd.json"
PROGRESS_FILE="$RALPH_DIR/progress.txt"

CURRENT_GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")

# Get repository name for worktree naming
REPO_NAME=$(basename "$(git rev-parse --show-toplevel 2>/dev/null)" 2>/dev/null || echo "repo")
ORIGINAL_DIR="$WORK_DIR"
WORKTREE_DIR=""

# Check if PRD exists, if not - guide user to create one
if [ ! -f "$PRD_FILE" ]; then
  echo ""
  echo "No PRD file found at $PRD_FILE"
  echo "You need to generate requirements first."
  echo ""
  echo "Starting $TOOL to help you create a task description..."
  echo "Use the PRD skill to generate a detailed requirements document, smth like:"
  echo "Load the prd skill and create a PRD for [your feature description]"
  echo "Answer the clarifying questions."
  echo ""

  # Start the tool in interactive mode
  if [[ "$TOOL" == "amp" ]]; then
    amp
  elif [[ "$TOOL" == "claude" ]]; then
    claude
  else
    if [[ -f "opencode.json" ]]; then
      opencode --config opencode.json
    else
      opencode
    fi
  fi

  echo ""
  echo "Now converting the created PRD to prd.json format..."

  # Find the latest PRD file in tasks/
  LATEST_PRD=$(ls -t "$RALPH_DIR/tasks/prd-"*.md 2>/dev/null | head -1)

  if [ -n "$LATEST_PRD" ] && [ -f "$LATEST_PRD" ]; then
    echo "Found PRD: $LATEST_PRD"
    # Convert to prd.json
    CONVERT_PROMPT="Load the ralph skill and convert $LATEST_PRD to prd.json"
    if [[ "$TOOL" == "amp" ]]; then
      echo "$CONVERT_PROMPT" | amp --dangerously-allow-all
    elif [[ "$TOOL" == "claude" ]]; then
      echo "$CONVERT_PROMPT" | claude --dangerously-skip-permissions --print
    else
      if [[ -f "opencode.json" ]]; then
        echo "$CONVERT_PROMPT" | opencode --config opencode.json run
      else
        echo "$CONVERT_PROMPT" | opencode run
      fi
    fi
  else
    echo "No PRD file found in tasks/ directory. Please create one manually."
    exit 1
  fi

  # Check if PRD was created successfully
  if [ ! -f "$PRD_FILE" ]; then
    echo "Failed to create PRD file. Please check the output above."
    exit 1
  fi

  PRD_BRANCH=$(jq -r '.branchName // empty' "$PRD_FILE" 2>/dev/null || echo "")

  echo ""
  echo "PRD specifies branch: $PRD_BRANCH"
  echo "Current branch: $CURRENT_GIT_BRANCH"

  # Setup worktree if requested and branch is specified
  if [ "$USE_WORKTREE" = true ] && [ -n "$PRD_BRANCH" ]; then

    if [ "$PRD_BRANCH" != "$CURRENT_GIT_BRANCH" ] || [ -z "$CURRENT_GIT_BRANCH" ]; then
      # Extract feature name without ralph/ prefix for worktree directory naming
      FEATURE_NAME=$(echo "$PRD_BRANCH" | sed 's|^ralph/||')
      WORKTREE_DIR="$ORIGINAL_DIR/../$REPO_NAME-$FEATURE_NAME"

      echo "Setting up worktree at: $WORKTREE_DIR"

      # Check if worktree already exists
      if [ -d "$WORKTREE_DIR" ]; then
        echo "Worktree directory already exists, using it..."
      else
        # Check if branch already exists
        if git show-ref --verify --quiet "refs/heads/$PRD_BRANCH"; then
          echo "Branch $PRD_BRANCH already exists, creating worktree from it..."
          git worktree add "$WORKTREE_DIR" "$PRD_BRANCH"
        else
          echo "Creating new branch $PRD_BRANCH and worktree..."
          git worktree add -b "$PRD_BRANCH" "$WORKTREE_DIR"
        fi
      fi

      # Copy PRD and related files from original repo to worktree
      ORIGINAL_RALPH="$ORIGINAL_DIR/.ralph"

      # Change to worktree directory
      cd "$WORKTREE_DIR"
      WORK_DIR="$WORKTREE_DIR"
      RALPH_DIR="$WORK_DIR/.ralph"
      PRD_FILE="$RALPH_DIR/prd.json"
      PROGRESS_FILE="$RALPH_DIR/progress.txt"
      mkdir -p "$RALPH_DIR"

      # Copy entire .ralph directory from original repo to worktree if it exists
      if [ -d "$ORIGINAL_RALPH" ] && [ "$(ls -A "$ORIGINAL_RALPH" 2>/dev/null)" ]; then
        echo "Copying .ralph directory from original repository to worktree..."
        cp -r "$ORIGINAL_RALPH"/* "$RALPH_DIR/"
      fi

      # Clean up .ralph directory in original repository using git
      echo "Cleaning up .ralph directory in original repository..."
      cd "$ORIGINAL_DIR"
      # This ensures .ralph is in clean committed state:
      # 1. Reset any staged changes in .ralph
      git reset HEAD .ralph 2>/dev/null || true
      # 2. Restore deleted/modified tracked files to their committed state
      git checkout HEAD -- .ralph 2>/dev/null || true
      # 3. Remove all untracked files and directories (like archive/)
      git clean -fd .ralph 2>/dev/null || true

      # Return to worktree
      cd "$WORKTREE_DIR"

      echo "Switched to worktree: $WORKTREE_DIR"
      echo "Original repository cleaned up"
      echo ""
    fi
  elif [ -n "$PRD_BRANCH" ] && [ -n "$CURRENT_GIT_BRANCH" ] && [ "$PRD_BRANCH" != "$CURRENT_GIT_BRANCH" ]; then
    # just checkout the branch

    # Check if branch already exists
    if git show-ref --verify --quiet "refs/heads/$PRD_BRANCH"; then
      echo "Branch $PRD_BRANCH already exists, switching to it..."
      git checkout "$PRD_BRANCH"
    else
      echo "Creating and switching to new branch: $PRD_BRANCH"
      git checkout -b "$PRD_BRANCH"
    fi
    echo ""
  fi

  # Commit new PRD and task description
  echo ""
  echo "Committing new PRD and task description..."
  PRD_COMMIT_PROMPT="Commit the newly created PRD files: .ralph/prd.json and any task description files in .ralph/tasks/"
  if [[ "$TOOL" == "amp" ]]; then
    echo "$PRD_COMMIT_PROMPT" | amp --dangerously-allow-all
  elif [[ "$TOOL" == "claude" ]]; then
    echo "$PRD_COMMIT_PROMPT" | claude --dangerously-skip-permissions --print
  else
    if [[ -f "opencode.json" ]]; then
      echo "$PRD_COMMIT_PROMPT" | opencode --config opencode.json run
    else
      echo "$PRD_COMMIT_PROMPT" | opencode run
    fi
  fi

fi

# Initialize progress file if it doesn't exist
if [ ! -f "$PROGRESS_FILE" ]; then
  echo "# Ralph Progress Log" > "$PROGRESS_FILE"
  echo "Started: $(date)" >> "$PROGRESS_FILE"
  echo "---" >> "$PROGRESS_FILE"
fi

echo "Starting Ralph - Tool: $TOOL - Max iterations: $MAX_ITERATIONS"

for i in $(seq 1 $MAX_ITERATIONS); do
  echo ""
  echo "==============================================================="
  echo "  Ralph Iteration $i of $MAX_ITERATIONS ($TOOL)"
  echo "==============================================================="


  # Run the selected tool with the ralph prompt
  if [[ "$TOOL" == "amp" ]]; then
    OUTPUT=$(cat "$PROMPT_FILE" | amp --dangerously-allow-all 2>&1 | tee /dev/stderr) || true
  elif [[ "$TOOL" == "claude" ]]; then
    OUTPUT=$(claude --dangerously-skip-permissions --print < "$PROMPT_FILE" 2>&1 | tee /dev/stderr) || true
  else
    if [[ ! -f "opencode.json" ]]; then
      OUTPUT=$(cat "$PROMPT_FILE" | opencode run 2>&1 | tee /dev/stderr) || true
    else
      OUTPUT=$(cat "$PROMPT_FILE" | opencode --config opencode.json run 2>&1 | tee /dev/stderr) || true
    fi
  fi

  # Check for completion signal
  if echo "$OUTPUT" | grep -q "<promise>COMPLETE</promise>"; then
    echo ""
    echo "Ralph completed all tasks!"
    echo "Completed at iteration $i of $MAX_ITERATIONS"

    # Cleanup worktree if used
    if [ "$USE_WORKTREE" = true ] && [ -n "$WORKTREE_DIR" ]; then
      echo ""
      echo "Worktree is at: $WORKTREE_DIR"
      echo "To merge changes, go to the original repository and run:"
      echo "  git merge $PRD_BRANCH"
      echo ""
      echo "After merging, you can clean up the worktree with:"
      echo "  cd $ORIGINAL_DIR"
      echo "  git worktree remove $WORKTREE_DIR"
      echo ""
    fi

    exit 0
  fi

  echo "Iteration $i complete. Continuing..."
  sleep 2
done

echo ""
echo "Ralph reached max iterations ($MAX_ITERATIONS) without completing all tasks."
echo "Check $PROGRESS_FILE for status."

# Cleanup info for worktree if used
if [ "$USE_WORKTREE" = true ] && [ -n "$WORKTREE_DIR" ]; then
  echo ""
  echo "Worktree is at: $WORKTREE_DIR"
  echo "To clean up the worktree later, run:"
  echo "  cd $ORIGINAL_DIR"
  echo "  git worktree remove $WORKTREE_DIR"
  echo ""
fi

exit 1
